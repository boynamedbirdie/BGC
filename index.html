<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stable Tracker ‚Äî 2025‚Äì26 CBB</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'IBM Plex Mono','Courier New',monospace;background:#0a0e17;color:#e8e6e3;min-height:100vh;-webkit-font-smoothing:antialiased}
    .header{background:linear-gradient(135deg,#1a1f2e,#0f1923);border-bottom:2px solid #e63946;padding:20px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .header-title{font-family:'Space Grotesk',sans-serif;font-size:26px;font-weight:700;letter-spacing:-.5px;color:#fff}
    .header-sub{font-size:11px;color:#8892a4;margin-top:2px;letter-spacing:1.5px;text-transform:uppercase}
    .header-right{font-size:11px;color:#8892a4;text-align:right}
    .header-right .accent{color:#e63946;font-weight:600}
    .tabs{display:flex;border-bottom:1px solid #1e2535;background:#0d1220}
    .tab-btn{flex:1;padding:14px 12px;border:none;background:0 0;color:#5a6478;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;letter-spacing:.5px;text-transform:uppercase;transition:all .2s}
    .tab-btn.active{background:#151b2e;color:#fff;font-weight:700;border-bottom-color:#e63946}
    .tab-btn:hover:not(.active){color:#8892a4}
    .content{padding:20px 16px;max-width:920px;margin:0 auto}
    .tab-panel{display:none}.tab-panel.active{display:block}
    .section-label{font-size:11px;color:#e63946;letter-spacing:2px;text-transform:uppercase;font-weight:700;margin-bottom:12px}
    .card{background:#111827;border-radius:8px;border:1px solid #1e2535;overflow:hidden}
    .tbl-header{display:grid;padding:10px 16px;background:#0d1220;border-bottom:1px solid #1e2535;font-size:10px;color:#5a6478;letter-spacing:1px;text-transform:uppercase;font-weight:600}
    .tbl-row{display:grid;padding:12px 16px;border-bottom:1px solid #1a2030;align-items:center;transition:background .1s}
    .tbl-row:last-child{border-bottom:none}.tbl-row:hover{background:rgba(255,255,255,.02)}.tbl-row.highlight{background:rgba(230,57,70,.06)}
    .standings-grid{grid-template-columns:36px 1fr 72px 72px 84px 84px}
    .rank{font-weight:700;font-size:14px;color:#5a6478}.rank.first{color:#e63946}
    .gambler-name{display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px;color:#c5c9d4}.gambler-name.first{color:#fff}
    .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;display:inline-block}.dot.sm{width:6px;height:6px}.dot.lg{width:10px;height:10px}
    .val-wins{text-align:right;font-weight:700;font-size:16px;color:#fff;font-family:'Space Grotesk',sans-serif}
    .val-losses{text-align:right;font-size:14px;color:#5a6478}
    .val-proj{text-align:right;font-size:13px;color:#8892a4}
    .val-payout{text-align:right;font-weight:700;font-size:14px;font-family:'Space Grotesk',sans-serif}
    .val-payout.pos{color:#2a9d8f}.val-payout.neg{color:#e63946}.val-payout.zero{color:#5a6478}
    .text-right{text-align:right}.text-center{text-align:center}
    .schedule-nav{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px}
    .nav-btn{background:#1a2030;border:1px solid #2a3344;color:#8892a4;padding:8px 14px;border-radius:6px;cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;transition:all .15s}
    .nav-btn:hover{background:#243044;color:#fff;border-color:#3a4a5e}
    .nav-date{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:#fff;min-width:200px;text-align:center}
    .nav-today-btn{background:0 0;border:1px solid #e6394644;color:#e63946;padding:4px 10px;border-radius:4px;cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;letter-spacing:.5px;transition:all .15s;margin-left:4px}
    .nav-today-btn:hover{background:#e6394622}
    .games-list{display:flex;flex-direction:column;gap:8px}
    .game-card{background:#111827;border-radius:8px;border:1px solid #1e2535;padding:14px 18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px}
    .game-card.stable-game{border-color:#e6394666;background:rgba(230,57,70,.03)}
    .game-team{font-size:14px;font-weight:600;font-family:'Space Grotesk',sans-serif}
    .game-team.in-stable{color:#fff}.game-team.not-stable{color:#5a6478}
    .game-owner{font-size:10px;font-weight:600;margin-top:2px}
    .game-score{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;margin-top:3px}
    .game-center{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:70px}
    .game-vs{font-size:10px;color:#e63946;font-weight:700;letter-spacing:1px}
    .game-time{font-size:10px;color:#5a6478}
    .game-status-final{font-size:10px;color:#2a9d8f;font-weight:700;letter-spacing:.5px}
    .game-status-live{font-size:10px;color:#e63946;font-weight:700;letter-spacing:.5px;animation:pulse 1.5s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .game-network{font-size:9px;color:#8892a4;background:#1a2030;padding:2px 8px;border-radius:4px;font-weight:600}
    .game-note{margin-top:10px;font-size:10px;color:#3d4655;font-style:italic}
    .game-count{font-size:11px;color:#5a6478;text-align:center;margin-bottom:12px}
    .no-games{background:#111827;border-radius:8px;border:1px solid #1e2535;padding:32px;text-align:center;color:#5a6478;font-size:13px}
    .schedule-loading{text-align:center;padding:24px;color:#5a6478;font-size:12px}
    .schedule-loading .mini-spinner{display:inline-block;width:16px;height:16px;border:2px solid #1e2535;border-top-color:#e63946;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px}
    .stable-card{margin-bottom:16px}
    .stable-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #1e2535}
    .stable-name{display:flex;align-items:center;gap:10px;font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;color:#fff}
    .stable-stats{display:flex;gap:16px;align-items:center}
    .stable-stat{text-align:right}
    .stable-stat-label{font-size:10px;color:#5a6478;letter-spacing:1px;text-transform:uppercase}
    .stable-stat-val{font-family:'Space Grotesk';font-weight:700}
    .stable-stat-val.big{font-size:20px;color:#fff}.stable-stat-val.med{font-size:16px;font-weight:600;color:#8892a4}
    .stable-team-hdr{display:grid;grid-template-columns:1fr 64px 64px 76px;padding:6px 18px;font-size:9px;color:#3d4655;letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid #161d2d}
    .stable-team-row{display:grid;grid-template-columns:1fr 64px 64px 76px;padding:8px 18px;border-bottom:1px solid #131a29;font-size:13px;align-items:center}
    .stable-team-row:last-child{border-bottom:none}
    .stable-team-name{color:#c5c9d4;font-weight:500}
    .pct-badge{font-size:11px;padding:1px 6px;border-radius:3px;font-weight:600;display:inline-block}
    .pct-badge.sm{font-size:10px;padding:1px 5px}
    .pct-good{background:rgba(42,157,143,.15);color:#2a9d8f}
    .pct-mid{background:rgba(233,196,106,.12);color:#e9c46a}
    .pct-bad{background:rgba(230,57,70,.12);color:#e63946}
    .teams-grid{grid-template-columns:1fr 90px 56px 56px 60px 72px}
    .sortable{cursor:pointer;user-select:none}.sortable:hover{color:#8892a4}
    .sort-arrow{font-size:10px}.sort-arrow.dim{opacity:.3}
    .team-scroll{max-height:600px;overflow-y:auto}
    .team-row{font-size:12px}.team-row:nth-child(even){background:rgba(255,255,255,.01)}
    .team-name{font-weight:500;color:#c5c9d4}
    .team-owner{display:flex;align-items:center;gap:6px;color:#8892a4;font-size:11px}
    .loading{text-align:center;padding:60px 20px;color:#5a6478}
    .loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid #1e2535;border-top-color:#e63946;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-box{background:rgba(230,57,70,.1);border:1px solid #e63946;border-radius:8px;padding:20px;color:#e8e6e3;font-size:13px;line-height:1.6}
    .error-box code{background:#1a2030;padding:2px 6px;border-radius:3px;font-size:12px}
    .last-updated{text-align:center;font-size:10px;color:#3d4655;padding:12px;border-top:1px solid #1a2030;margin-top:24px}
    @media(max-width:600px){
      .header-title{font-size:20px}.header-sub{font-size:9px}
      .standings-grid{grid-template-columns:28px 1fr 52px 52px 64px 68px}.standings-grid .val-wins{font-size:14px}
      .teams-grid{grid-template-columns:1fr 70px 44px 44px 52px 60px}
      .game-card{padding:12px;gap:8px}.game-team{font-size:12px}
      .stable-header{flex-direction:column;gap:10px;align-items:flex-start}
      .content{padding:16px 10px}.nav-date{font-size:13px;min-width:150px}.nav-btn{padding:6px 10px;font-size:11px}
    }
  </style>
</head>
<body>
  <div class="header">
    <div><div class="header-title">üèÄ STABLE TRACKER</div><div class="header-sub">2025‚Äì26 College Basketball Season ‚Ä¢ 8 Gamblers ‚Ä¢ 64 Teams</div></div>
    <div class="header-right"><div id="todayDate"></div><div class="accent">$1 per win per opponent</div></div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" data-tab="standings">Standings & Schedule</button>
    <button class="tab-btn" data-tab="stables">Stables</button>
    <button class="tab-btn" data-tab="teams">Team Data</button>
  </div>
  <div class="content">
    <div id="loading" class="loading"><div class="spinner"></div><div>Loading data from Google Sheets...</div></div>
    <div id="error" style="display:none"></div>
    <div id="tab-standings" class="tab-panel active"></div>
    <div id="tab-stables" class="tab-panel"></div>
    <div id="tab-teams" class="tab-panel"></div>
  </div>
  <div class="last-updated" id="lastUpdated"></div>
<script>
const SHEET_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsAmfvCG1dfQZ9jxXKVkEtSxFD0Ad9OaOkszlICTMJRzIcOkMTLP1YFoy-4gzg5R1oXtPTmA9YgCl/pub?gid=2069986082&single=true&output=csv";
const GAMBLER_COLORS={Dave:"#e63946",Kyle:"#457b9d",Lanny:"#2a9d8f",Zac:"#e9c46a",Hammen:"#f4a261",James:"#264653",Deva:"#7209b7",Zim:"#606c38"};
const TEAM_ALIASES={
  "St. John's":"St John's","St. John's (NY)":"St John's","St. John's Red Storm":"St John's",
  "San Diego State":"San Diego St","San Diego State Aztecs":"San Diego St",
  "Colorado State":"Colorado St","Colorado State Rams":"Colorado St",
  "Norfolk State":"Norfolk St","Norfolk State Spartans":"Norfolk St",
  "Utah State":"Utah St","Utah State Aggies":"Utah St",
  "Hawai'i Rainbow Warriors":"Hawai'i","Hawaii Rainbow Warriors":"Hawai'i","Hawaii":"Hawai'i",
  "Illinois State":"Illinois St","Illinois State Redbirds":"Illinois St",
  "Miami (OH) RedHawks":"Miami OH","Miami RedHawks":"Miami OH","Miami (OH)":"Miami OH",
  "Michigan State":"Michigan St","Michigan State Spartans":"Michigan St",
  "Kent State":"Kent St","Kent State Golden Flashes":"Kent St",
  "Iowa State":"Iowa St","Iowa State Cyclones":"Iowa St",
  "George Washington":"G Washington","George Washington Revolutionaries":"G Washington",
  "Saint Mary's (CA)":"Saint Mary's","Saint Mary's Gaels":"Saint Mary's",
  "UNC Wilmington":"NC Wilmington","UNC Wilmington Seahawks":"NC Wilmington","UNCW":"NC Wilmington",
  "Northern Iowa":"N Iowa","Northern Iowa Panthers":"N Iowa",
  "Ole Miss":"Mississippi","Ole Miss Rebels":"Mississippi","Mississippi Rebels":"Mississippi",
  "St. Thomas":"St Thomas","St. Thomas (MN)":"St Thomas","Saint Thomas":"St Thomas","St. Thomas Tommies":"St Thomas",
  "Connecticut":"UConn","UConn Huskies":"UConn",
  "Boise State":"Boise St","Boise State Broncos":"Boise St",
  "UC Santa Barbara":"UCSB","UC Santa Barbara Gauchos":"UCSB",
  "Little Rock Trojans":"Little Rock","Arkansas-Little Rock":"Little Rock","Arkansas State - Little Rock":"Little Rock",
};

const now=new Date();
const dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
const shortMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
document.getElementById("todayDate").textContent=`${dayNames[now.getDay()]}, ${monthNames[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;

function dateToESPN(d){return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`}
function formatDateLabel(d){
  const today=new Date();today.setHours(0,0,0,0);
  const cmp=new Date(d);cmp.setHours(0,0,0,0);
  const diff=Math.round((cmp-today)/864e5);
  let pfx=diff===0?"Today ‚Äî ":diff===-1?"Yesterday ‚Äî ":diff===1?"Tomorrow ‚Äî ":"";
  return `${pfx}${dayNames[d.getDay()]}, ${shortMonths[d.getMonth()]} ${d.getDate()}`;
}
function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
  });
});

function parseCSV(t){
  const lines=t.trim().split("\n"),rows=[];
  for(let i=0;i<lines.length;i++){
    const parts=[];let cur="",inQ=false;
    for(let c=0;c<lines[i].length;c++){
      const ch=lines[i][c];
      if(ch==='"')inQ=!inQ;
      else if(ch===','&&!inQ){parts.push(cur.trim());cur="";}
      else cur+=ch;
    }
    parts.push(cur.trim());rows.push(parts);
  }
  return rows;
}

function processData(rows){
  let hIdx=0;
  for(let i=0;i<Math.min(rows.length,5);i++){
    if(rows[i].map(c=>c.toLowerCase()).some(c=>c.includes("gambler")||c.includes("team"))){hIdx=i;break;}
  }
  const data=[];
  for(let i=hIdx+1;i<rows.length;i++){
    const r=rows[i];if(!r[0]||!r[1])continue;
    const g=r[0].trim(),tm=r[1].trim(),w=parseInt(r[2])||0,l=parseInt(r[3])||0,pw=parseFloat(r[4])||0;
    if(g&&tm)data.push({gambler:g,team:tm,wins:w,losses:l,projWins:pw});
  }
  return data;
}

function getStandings(data){
  const m={};
  data.forEach(d=>{
    if(!m[d.gambler])m[d.gambler]={gambler:d.gambler,totalWins:0,totalLosses:0,totalProjWins:0};
    m[d.gambler].totalWins+=d.wins;m[d.gambler].totalLosses+=d.losses;m[d.gambler].totalProjWins+=d.projWins;
  });
  const a=Object.values(m).sort((a,b)=>b.totalWins-a.totalWins);
  a.forEach(s=>{s.payout=0;a.forEach(o=>{if(o.gambler!==s.gambler)s.payout+=(s.totalWins-o.totalWins);});});
  return a;
}

function pctBadge(w,l,sm){
  const p=w/(w+l),c=p>=.75?"pct-good":p>=.5?"pct-mid":"pct-bad";
  const s=p===1?"1.000":"."+Math.round(p*1000).toString().padStart(3,"0");
  return `<span class="pct-badge ${sm?'sm':''} ${c}">${s}</span>`;
}
function payoutStr(p){
  if(p>0)return `<span class="val-payout pos">+$${p}</span>`;
  if(p<0)return `<span class="val-payout neg">\u2212$${Math.abs(p)}</span>`;
  return `<span class="val-payout zero">$0</span>`;
}
function colorDot(g,sz){return `<span class="dot ${sz||''}" style="background:${GAMBLER_COLORS[g]||'#5a6478'}"></span>`}

let teamOwnerMap={};
function buildTeamOwnerMap(data){teamOwnerMap={};data.forEach(d=>{teamOwnerMap[d.team.toLowerCase()]=d.gambler;});}
function findOwner(name){
  if(!name)return null;
  const lo=name.toLowerCase();
  if(teamOwnerMap[lo])return teamOwnerMap[lo];
  const alias=TEAM_ALIASES[name];
  if(alias&&teamOwnerMap[alias.toLowerCase()])return teamOwnerMap[alias.toLowerCase()];
  for(const[k,v]of Object.entries(TEAM_ALIASES)){
    if(k.toLowerCase()===lo&&teamOwnerMap[v.toLowerCase()])return teamOwnerMap[v.toLowerCase()];
  }
  for(const k of Object.keys(teamOwnerMap)){
    if(lo.includes(k)||k.includes(lo))return teamOwnerMap[k];
  }
  return null;
}

/* ‚ïê‚ïê‚ïê ESPN ‚ïê‚ïê‚ïê */
let scheduleDate=new Date();scheduleDate.setHours(0,0,0,0);

async function fetchESPN(ds){
  try{
    const r=await fetch(`https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?dates=${ds}&limit=400`);
    if(!r.ok)throw new Error();return(await r.json()).events||[];
  }catch(e){return null;}
}

function parseGames(evts){
  return evts.map(ev=>{
    const c=ev.competitions&&ev.competitions[0];if(!c)return null;
    const ts=c.competitors||[],aw=ts.find(t=>t.homeAway==="away"),hm=ts.find(t=>t.homeAway==="home");
    if(!aw||!hm)return null;
    const st=(c.status||{}).type||{},done=st.completed===true,live=st.state==="in",detail=st.shortDetail||"";
    let net="";if(c.broadcasts&&c.broadcasts.length>0)net=(c.broadcasts[0].names||[]).join(", ");
    const gd=new Date(ev.date);
    const time=gd.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:true,timeZone:"America/New_York"})+" ET";
    return{
      awayName:aw.team.displayName||aw.team.name,awayScore:parseInt(aw.score)||0,awayWinner:aw.winner===true,
      awayRank:aw.curatedRank&&aw.curatedRank.current<=25?aw.curatedRank.current:null,
      homeName:hm.team.displayName||hm.team.name,homeScore:parseInt(hm.score)||0,homeWinner:hm.winner===true,
      homeRank:hm.curatedRank&&hm.curatedRank.current<=25?hm.curatedRank.current:null,
      isCompleted:done,isLive:live,statusText:detail,network:net,timeStr:time
    };
  }).filter(Boolean);
}

function renderGames(games){
  const el=document.getElementById("scheduleGames");
  if(games===null){el.innerHTML=`<div class="no-games">\u26a0\ufe0f Could not load schedule from ESPN. Try refreshing.</div>`;return;}
  const sg=games.filter(g=>findOwner(g.awayName)||findOwner(g.homeName));
  if(!games.length){el.innerHTML=`<div class="no-games">No games scheduled for this day.</div>`;return;}
  if(!sg.length){el.innerHTML=`<div class="no-games">No stable teams playing this day. (${games.length} other games scheduled)</div>`;return;}
  sg.sort((a,b)=>{if(a.isLive!==b.isLive)return a.isLive?-1:1;if(a.isCompleted!==b.isCompleted)return a.isCompleted?1:-1;return 0;});
  let h=`<div class="game-count">${sg.length} stable game${sg.length!==1?'s':''} \u00b7 ${games.length} total games</div><div class="games-list">`;
  sg.forEach(g=>{
    const ao=findOwner(g.awayName),ho=findOwner(g.homeName),both=ao&&ho;
    const rb=r=>r?`<span style="font-size:10px;color:#e9c46a;font-weight:600">#${r} </span>`:"";
    let ac=ao?"game-team in-stable":"game-team not-stable";
    let hc=ho?"game-team in-stable":"game-team not-stable";
    let asc="#fff",hsc="#fff";
    if(g.isCompleted){asc=g.awayWinner?"#2a9d8f":"#5a6478";hsc=g.homeWinner?"#2a9d8f":"#5a6478";}
    h+=`<div class="game-card ${both?'stable-game':''}">`;
    h+=`<div style="text-align:right"><div class="${ac}">${rb(g.awayRank)}${g.awayName}</div>`;
    if(ao)h+=`<div class="game-owner" style="color:${GAMBLER_COLORS[ao]};text-align:right">${ao}'s stable</div>`;
    if(g.isCompleted||g.isLive)h+=`<div class="game-score" style="text-align:right;color:${asc}">${g.awayScore}</div>`;
    h+=`</div><div class="game-center">`;
    if(g.isCompleted){h+=`<div class="game-status-final">FINAL</div>`;if(g.statusText&&g.statusText.toLowerCase().includes("ot"))h+=`<div class="game-time">${g.statusText}</div>`;}
    else if(g.isLive){h+=`<div class="game-status-live">\u25cf LIVE</div><div class="game-time">${g.statusText}</div>`;}
    else{h+=`<div class="game-vs">VS</div><div class="game-time">${g.timeStr}</div>`;}
    if(g.network)h+=`<div class="game-network">${g.network}</div>`;
    h+=`</div><div><div class="${hc}">${rb(g.homeRank)}${g.homeName}</div>`;
    if(ho)h+=`<div class="game-owner" style="color:${GAMBLER_COLORS[ho]}">${ho}'s stable</div>`;
    if(g.isCompleted||g.isLive)h+=`<div class="game-score" style="color:${hsc}">${g.homeScore}</div>`;
    h+=`</div></div>`;
  });
  h+=`</div><div class="game-note">* Only games with stable teams shown. Stable vs. stable matchups have a red border.</div>`;
  el.innerHTML=h;
}

async function loadSchedule(d){
  document.getElementById("scheduleGames").innerHTML=`<div class="schedule-loading"><span class="mini-spinner"></span> Loading schedule...</div>`;
  document.getElementById("scheduleDate").textContent=formatDateLabel(d);
  document.getElementById("todayBtn").style.display=isSameDay(d,new Date())?"none":"inline-block";
  const evts=await fetchESPN(dateToESPN(d));
  renderGames(evts===null?null:parseGames(evts));
}
function changeDay(n){scheduleDate.setDate(scheduleDate.getDate()+n);loadSchedule(scheduleDate);}
function goToToday(){scheduleDate=new Date();scheduleDate.setHours(0,0,0,0);loadSchedule(scheduleDate);}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
function renderStandings(data){
  const st=getStandings(data),c=document.getElementById("tab-standings");
  let h=`<div class="section-label">Current Standings</div><div class="card"><div class="tbl-header standings-grid"><div>#</div><div>Gambler</div><div class="text-right">Wins</div><div class="text-right">Losses</div><div class="text-right">Proj W</div><div class="text-right">Payout</div></div>`;
  st.forEach((s,i)=>{const f=i===0;
    h+=`<div class="tbl-row standings-grid ${f?'highlight':''}"><div class="rank ${f?'first':''}">${i+1}</div><div class="gambler-name ${f?'first':''}">${colorDot(s.gambler,'')} ${s.gambler}</div><div class="val-wins">${s.totalWins}</div><div class="val-losses">${s.totalLosses}</div><div class="val-proj">${s.totalProjWins.toFixed(1)}</div><div>${payoutStr(s.payout)}</div></div>`;
  });
  h+=`</div><div style="margin-top:32px"><div class="section-label">Stable Schedule</div>`;
  h+=`<div class="schedule-nav"><button class="nav-btn" onclick="changeDay(-1)">\u25c0 Prev</button><div><span class="nav-date" id="scheduleDate"></span><button class="nav-today-btn" id="todayBtn" onclick="goToToday()" style="display:none">TODAY</button></div><button class="nav-btn" onclick="changeDay(1)">Next \u25b6</button></div>`;
  h+=`<div id="scheduleGames"></div></div>`;
  c.innerHTML=h;loadSchedule(scheduleDate);
}

function renderStables(data){
  const st=getStandings(data),c=document.getElementById("tab-stables");let h="";
  st.forEach(s=>{
    const teams=data.filter(d=>d.gambler===s.gambler).sort((a,b)=>b.wins-a.wins);
    const col=GAMBLER_COLORS[s.gambler]||"#5a6478";
    h+=`<div class="card stable-card"><div class="stable-header" style="background:linear-gradient(135deg,${col}18,transparent)"><div class="stable-name">${colorDot(s.gambler,'lg')} ${s.gambler}</div><div class="stable-stats"><div class="stable-stat"><div class="stable-stat-label">Wins</div><div class="stable-stat-val big">${s.totalWins}</div></div><div class="stable-stat"><div class="stable-stat-label">Proj</div><div class="stable-stat-val med">${s.totalProjWins.toFixed(1)}</div></div><div class="stable-stat"><div class="stable-stat-label">P/L</div><div class="stable-stat-val">${payoutStr(s.payout)}</div></div></div></div>`;
    h+=`<div class="stable-team-hdr"><div>Team</div><div class="text-center">Record</div><div class="text-center">Win%</div><div class="text-right">Proj W</div></div>`;
    teams.forEach(t=>{h+=`<div class="stable-team-row"><div class="stable-team-name">${t.team}</div><div class="text-center" style="color:#8892a4;font-size:12px">${t.wins}-${t.losses}</div><div class="text-center">${pctBadge(t.wins,t.losses,false)}</div><div class="text-right" style="color:#5a6478;font-size:12px">${t.projWins}</div></div>`;});
    h+=`</div>`;
  });
  c.innerHTML=h;
}

let teamSortKey="wins",teamSortDir="desc",globalData=[];
function renderTeams(data){
  globalData=data;const c=document.getElementById("tab-teams");
  const sorted=[...data].sort((a,b)=>{
    switch(teamSortKey){
      case"team":return teamSortDir==="asc"?a.team.localeCompare(b.team):b.team.localeCompare(a.team);
      case"gambler":return teamSortDir==="asc"?a.gambler.localeCompare(b.gambler):b.gambler.localeCompare(a.gambler);
      case"wins":return teamSortDir==="asc"?a.wins-b.wins:b.wins-a.wins;
      case"losses":return teamSortDir==="asc"?a.losses-b.losses:b.losses-a.losses;
      case"winPct":{const ap=a.wins/(a.wins+a.losses),bp=b.wins/(b.wins+b.losses);return teamSortDir==="asc"?ap-bp:bp-ap;}
      case"projWins":return teamSortDir==="asc"?a.projWins-b.projWins:b.projWins-a.projWins;
      default:return b.wins-a.wins;
    }
  });
  const arrow=col=>teamSortKey!==col?`<span class="sort-arrow dim">\u2195</span>`:`<span class="sort-arrow">${teamSortDir==="asc"?"\u2191":"\u2193"}</span>`;
  let h=`<div class="section-label">All ${data.length} Teams \u2014 Click Headers to Sort</div><div class="card">`;
  h+=`<div class="tbl-header teams-grid"><div class="sortable" data-sort="team">Team ${arrow("team")}</div><div class="sortable" data-sort="gambler">Owner ${arrow("gambler")}</div><div class="sortable text-right" data-sort="wins">W ${arrow("wins")}</div><div class="sortable text-right" data-sort="losses">L ${arrow("losses")}</div><div class="sortable text-right" data-sort="winPct">Win% ${arrow("winPct")}</div><div class="sortable text-right" data-sort="projWins">Proj W ${arrow("projWins")}</div></div>`;
  h+=`<div class="team-scroll">`;
  sorted.forEach(t=>{
    h+=`<div class="tbl-row teams-grid team-row"><div class="team-name">${t.team}</div><div class="team-owner">${colorDot(t.gambler,'sm')} ${t.gambler}</div><div class="text-right" style="font-weight:600;color:#fff">${t.wins}</div><div class="text-right" style="color:#5a6478">${t.losses}</div><div class="text-right">${pctBadge(t.wins,t.losses,true)}</div><div class="text-right" style="color:#8892a4">${t.projWins}</div></div>`;
  });
  h+=`</div></div>`;c.innerHTML=h;
  c.querySelectorAll(".sortable").forEach(el=>{
    el.addEventListener("click",()=>{
      const k=el.dataset.sort;
      if(teamSortKey===k)teamSortDir=teamSortDir==="asc"?"desc":"asc";
      else{teamSortKey=k;teamSortDir="desc";}
      renderTeams(globalData);
    });
  });
}

/* ‚ïê‚ïê‚ïê GOOGLE SHEETS FETCH (CORS-FRIENDLY) ‚ïê‚ïê‚ïê */
// The /pub?output=csv endpoint often has CORS issues.
// The gviz/tq endpoint returns JSONP-like data that supports CORS.
const SHEET_ID="16AKVojcH_H1RmzEx4zHPJ_okEM5BVUbRh_ofptz_amw";
const SHEET_GID="2069986082";

function parseGvizResponse(text){
  // Response looks like: google.visualization.Query.setResponse({...json...});
  const match=text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);?\s*$/);
  if(!match)return null;
  const json=JSON.parse(match[1]);
  if(!json.table)return null;
  const cols=json.table.cols;
  const rows=json.table.rows;
  const data=[];
  rows.forEach(row=>{
    const cells=row.c;
    if(!cells||!cells[0]||!cells[1])return;
    const gambler=(cells[0]&&cells[0].v)?String(cells[0].v).trim():"";
    const team=(cells[1]&&cells[1].v)?String(cells[1].v).trim():"";
    const wins=(cells[2]&&cells[2].v)?parseInt(cells[2].v)||0:0;
    const losses=(cells[3]&&cells[3].v)?parseInt(cells[3].v)||0:0;
    const projWins=(cells[4]&&cells[4].v)?parseFloat(cells[4].v)||0:0;
    if(gambler&&team&&gambler.toLowerCase()!=="gambler")data.push({gambler,team,wins,losses,projWins});
  });
  return data;
}

async function fetchSheetData(){
  // Method 1: Try the gviz/tq endpoint (CORS-friendly)
  try{
    const gvizUrl=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
    const r=await fetch(gvizUrl);
    if(r.ok){
      const text=await r.text();
      const data=parseGvizResponse(text);
      if(data&&data.length>0)return{data,method:"gviz"};
    }
  }catch(e){console.log("gviz failed, trying CSV...",e);}

  // Method 2: Try the published CSV URL
  try{
    const r=await fetch(SHEET_CSV_URL);
    if(r.ok){
      const data=processData(parseCSV(await r.text()));
      if(data.length>0)return{data,method:"csv"};
    }
  }catch(e){console.log("CSV failed too",e);}

  // Method 3: Try alternate CSV URL format
  try{
    const altUrl=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
    const r=await fetch(altUrl);
    if(r.ok){
      const data=processData(parseCSV(await r.text()));
      if(data.length>0)return{data,method:"export"};
    }
  }catch(e){console.log("Export CSV failed too",e);}

  return null;
}

async function init(){
  try{
    const result=await fetchSheetData();
    if(!result)throw new Error("All fetch methods failed. The Google Sheet may not be accessible.");
    const data=result.data;
    if(!data.length)throw new Error("No data found in the sheet.");
    document.getElementById("loading").style.display="none";
    buildTeamOwnerMap(data);renderStandings(data);renderStables(data);renderTeams(data);
    document.getElementById("lastUpdated").textContent=`Data loaded from Google Sheets (${result.method}) \u2022 ${new Date().toLocaleString()}`;
  }catch(e){
    document.getElementById("loading").style.display="none";
    document.getElementById("error").style.display="block";
    document.getElementById("error").innerHTML=`<div class="error-box"><strong>\u26a0\ufe0f Could not load data</strong><br><br>${e.message}<br><br>
    <strong>Troubleshooting:</strong><br>
    1. Make sure the sheet is published: File \u2192 Share \u2192 Publish to web<br>
    2. Make sure the sheet is shared as "Anyone with the link can view"<br>
    3. Try refreshing the page<br><br>
    <small>Sheet ID: ${SHEET_ID} | GID: ${SHEET_GID}</small></div>`;
  }
}
init();
</script>
</body>
</html>
